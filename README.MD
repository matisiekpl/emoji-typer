# Konteneryzacja aplikacji i wdro偶enie na klaster Kubernetes  
> Ten poradnik pokazuje w jaki spos贸b skonteneryzowa aplikacj webow napisan w Go oraz wdro偶y j na klaster Kubernetes postawiony na infrastrukturze dostawcy Vultr. 

## Krok 1  
> Skonteneryzuj aplikacj. Aplikacj mo偶emy spakowa do tak zwanego kontenera. Jest to specjalne "opakowanie" na oprogramowanie, kt贸re pozwala uruchomi je zawsze w taki sam spos贸b, niezale偶nie od rodowiska. W kocu mo偶emy po偶egna teksty typu "Ale u mnie dziaa"

W tym celu tworzymy plik Dockerfile w g贸wnym katalogu projektu
```dockerfile
FROM golang AS build
# utworz katalog roboczy
RUN mkdir -p /go/src/emoji_typer
# ustaw go jako aktualny katalog roboczy
WORKDIR /go/src/emoji_typer
# skopiuj kod do niego
COPY . .
# zainstaluj program pakujacy pliki statyczne Packr2
RUN go install github.com/gobuffalo/packr/v2/packr2@v2.8.3
# niech Packr2 spakuje pliki statyczne
RUN packr2 
# skompiluj program
RUN go build -ldflags "-linkmode external -extldflags -static" emoji_typer

# utworz nowy kontener, zawierajacy jedynie skompilowany plik z kodem maszynowym
FROM scratch
# skopiuj plik wykonywalny
COPY --from=build /go/src/emoji_typer/emoji_typer /emoji_typer
# powiedz Dockerowi, by podczas uruchamiania kontenera, wywolal ten plik
CMD ["/emoji_typer"]
```

## Krok 2  
> Utw贸rz obraz kontenera i wypchnij go do rejestru kontener贸w.

Kompilujemy kontener do jego obrazu (kt贸ry potem stanowi podstaw do tworzenia kontenera na serwerze). Nastpnie zmieniamy jego nazw (rejestr kontener贸w wymaga prefixu zawierajcego login u偶ytkownika). Nastpnie wypychamy obraz do rejestru
```bash
$ docker build -t emoji-typer .
$ docker tag emoji-typer matisiekpl/emoji-typer
$ docker push matisiekpl/emoji-typer
```

![img.png](images/img.png)

## Krok 3  锔
> Tworzenie serwera VPS u dostawcy Vultr

Po utworzeniu konta przechodzimy do panelu serwer贸w:
![img_5.png](images/img_5.png)

Klikamy "Deploy instance". Otwiera si panel zamawiania serwera. Wybieramy pul serwer贸w wysokiej czstotliwoci. Nastpnie wybieramy lokalizacj. Sztokholm wydaje si rozsdny, bo nie jest zbyt daleko Polski (wybierajc Stany Zjednoczone Ameryki mo偶na by byo odczu op贸藕nienia zwizane z tym, 偶e transmisja musiaaby zosta przesana przez infrastruktur pod oceanem)
![img_6.png](images/img_6.png)

Nastpnie wybieramy system operacyjny. Wybraem sw贸j ulubiony czyli Ubuntu Server 20.04 LTS. Konfiguracj maszyny wirtualnej wybieram 1 wersji 1vcpu/1gb ze wzgldu na studenck cen
![img_7.png](images/img_7.png)

Czekamy a偶 system si zainstaluje
![img_8.png](images/img_8.png)

Nastpnie czymy si za pomoc protokou SSH, u偶ywajc danych z lewej kolumny

![img_12.png](images/img_12.png)

![img_9.png](images/img_9.png)

Jako dystrybucj platformy Kubernetes wybraem lekki i szybki K3S od Ranchera
![img_10.png](images/img_10.png)

Instalujemy Kubernetes za pomoc komendy:
```bash
$ curl -sfL https://get.k3s.io | sh -
```
![img_11.png](images/img_11.png)

> W tym miejscu nale偶aoby wytumaczy spos贸b organizacji zasob贸w w klastrze Kubernetes
> 
> Pod - to grupa kontener贸w. Najczciej pod zawiera jeden kontener z nasz aplikacj, cho mo偶emy doda ich wicej.
> 
> ReplicaSet - to zas贸b kt贸ry zarzdza tworzeniem/usuwaniem Pod贸w. W zasobie ReplicaSet mo偶emy zdefiniowa docelow ilo Pod贸w aplikacji. ReplicaSet bdzie d偶y do tego, aby aktualna liczba Pod贸w bya r贸wna zadanej. 
>
> Deployment - to zas贸b kt贸ry reprezentuje pene wdro偶enie aplikacji. Zarzdza on ReplicaSetami. Ma r贸wnie偶 mo偶liwo np. podmiany wersji aplikacji w ReplicaSetach
> 
> Service - to zas贸b zarzdzajcy ruchem w rodku klastra. Odbiera pakiety i przekazuje je do pod贸w w cile okrelony spos贸b
> 
> Po co to wszystko? Przecie偶 mo偶na by byo uruchomi kontener rcznie ---- owszem, mo偶na by byo. Ale je偶eli do klastra doczymy kolejne serwery, to Kubernetes bdzie czuwa nad tym, aby aplikacja bya r贸wnomiernie uruchomiona na wszystkich wzach, a ruch by r贸wnomiernie dystrybuowany na wszystkie wzy (serwery podczone do Kubernetes).

# Krok 4  
> Utworzenie konfiguracji wdro偶eniowej i zaaplikowanie jej na klaster

Teraz musimy utworzy pliki konfigurcyjne. Dobr praktyk jest tworzenie ich w repozytorium
Utw贸rzmy wic plik konfiguracyjny zawierajcy zasoby Deployment 

Plik: deployment.k8s.yaml
```yaml
apiVersion: apps/v1
kind: Deployment # typ zasobu
metadata:
  name: emoji-typer # nazwa zasobu
spec:
  selector:
    matchLabels:
      app: emoji-typer # Zas贸b Deployment bdzie zarzdza ReplicaSetami, kt贸rych etykieta app=emoji-typer
  replicas: 5 # Liczba pod贸w w replice. Je偶eli mamy np. trzy serwery, to te 5 pod贸w zostanie rozproszone na trzy serwery (czyli za pewne na pierwszy i drugi serwer bd przypada dwa pody a na ostatni - jeden)
  template:
    metadata:
      labels:
        app: emoji-typer # ReplicaSety bd zawiera etykiet app=emoji-typer
    spec:
      containers:
        - name: emoji-typer
          image: matisiekpl/emoji-typer # Nazwa obrazu z kontenera
          ports:
            - containerPort: 3000 # Port, kt贸ry kontener wystawia na wiat
---
apiVersion: v1
kind: Service
metadata:
  name: emoji-typer # tym razem tworzymy jednak zas贸b Service
spec:
  selector:
    app: emoji-typer # kierujemy pakiety z zewntrz do pod贸w, kt贸rych etykieta app=emoji-typer
  type: NodePort # typ kierowania, NodePort wystawia jeden port na wiat
  ports:
    - protocol: TCP # protok贸 pakiet贸w
      nodePort: 30123 # port, kt贸ry jest wystawiany na wiat na zewntrz VPS
      targetPort: 3000 # port docelowy, czyli ten, na kt贸rym nasuchuje Pod
      port: 30123 # port og贸lny, dla kierowania NodePort r贸wny nodePort
```
Taki plik commitujemy i wypychamy do repozytorium.
Nastpnie mo偶emy go pobra na serwerze, po czym wywoa komend `kubectl apply`, aby konfiguracja zostaa zastosowana na klastrze.

![img_13.png](images/img_13.png)

Jak wida tu偶 po wywoaniu komendy, nie wszystkie pody zostay stworzone. Jednak po chwili nasze pody zyskay status `Running` co oznacza, 偶e obraz zosta pobrany i uruchomiony. Zas贸b `Service` r贸wnie偶 wyglda okej.

Przechodzc pod adres serwera (z dopiskiem portu 30123) widzimy, 偶e wszystko dziaa:

![img_14.png](images/img_14.png)

![img_15.png](images/img_15.png)

Warto zwr贸ci uwag na to, 偶e ruch jest kierowany w spos贸b losowy a wic nazwa wza widoczna w aplikacji bdzie si zmienia
![img_16.png](images/img_16.png)

Widzimy wic, 偶e osignelimy dystrybucj ruchu na wiele pod贸w w obrbie ReplicaSetu. Nasza aplikacja zostaa wdro偶ona

# Udao si! 
Widzimy wic, 偶e wdro偶enie aplikacji za pomoc Kubernetesa nie jest wcale trudne. Mo偶liwoci Kubernetesa s jednak o wiele wiksze, a w przypadku popularnych aplikacji webowych, rozproszone wdro偶enie usug jest wrcz konieczne 
